Alpaka Plugin
=============

The CODEGEN directory contains the plugin "standalone_alpaka_cudacpp"
(which is in the directory called "ALPAKA_CUDACPP_SA_OUTPUT").

It is derived from the plugin of
https://github.com/madgraph5/madgraph4gpu/tree/golden_epochX4/epochX/cudacpp/CODEGEN/PLUGIN/CUDACPP_SA_OUTPUT

This has been tested with madgraph revision, Alpaka version 0.8.0
and Cupla version 0.3.0, CUDA version 11.6 and g++ 10.2.0.

The code generated by this plugin can be compiled in 3 ways:

* As C++
* Using Native CUDA
* Using ALPAKA (and CUPLA), where the default Makefile will setup the ALPAKA code to build for CUDA.

The Makefile is setup to build 3 versions of check.exe for
testing of C++, native CUDA and ALPAKA (targeting CUDA) builds.
These are named check.exe, gcheck.exe and alpcheck.exe.

The make process should also build a single executable, runTest.exe, that runs the some
tests using the C++ and ALPAKA versions.

Building
========

It is assumed that Bazaar, boost, git, CUDA and a C++ compiler are installed
(and possibly others). Choose a new, empty working directory:

checkout madgraph and the madgraph gpu repo:

```
mkdir -p mad-bzr/2.7.0_gpu
bzr checkout -r 370 http://bazaar.launchpad.net/~maddevelopers/mg5amcnlo/2.7.0_gpu mad-bzr/2.7.0_gpu
git clone https://github.com/madgraph5/madgraph4gpu.git

```

install the Alpaka plugin in the madgraph directory:

```
cp -rp madgraph4gpu/epochX/alpaka/CODEGEN/PLUGIN/ALPAKA_CUDACPP_SA_OUTPUT mad-bzr/2.7.0_gpu/PLUGIN
```

Checkout Alpaka and Cupla and setup some links and environment:

```
git clone -b 0.8.0 https://github.com/alpaka-group/alpaka.git
git clone -b 0.3.0 https://github.com/alpaka-group/cupla.git

ln -s madgraph4gpu/test .
ln -s madgraph4gpu/tools .

export ALPAKA_ROOT=`pwd`/alpaka
export CUPLA_ROOT=`pwd`/cupla
```

Use madgraph to genreate a process and use the plugin:

```
cd mad-bzr/2.7.0_gpu
python3 ./bin/mg5_aMC

> generate g g > t t~ g g
> output standalone_alpaka_cudacpp TEST_SA_CUDA
> quit
```

Compile the generated code:

```
cd TEST_SA_CUDA/SubProcesses/P1_Sigma_sm_gg_ttxgg/
ln -s ../../../../../tools/CommonRandomNumbers.h .
make BOOSTINC=/usr/include/boost-1.78.0

# the make should have generated check and test programs.
./alpcheck.exe -p 16384 16 1
```
