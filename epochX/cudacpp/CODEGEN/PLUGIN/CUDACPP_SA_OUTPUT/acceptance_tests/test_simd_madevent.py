# WARNING THIS FILE IS AUTOGENERATED -> edit test_simd_madevent.template


################################################################################
#
# Copyright (c) 2009 The MadGraph5_aMC@NLO Development team and Contributors
#
# This file is a part of the MadGraph5_aMC@NLO project, an application which 
# automatically generates Feynman diagrams and matrix elements for arbitrary
# high-energy processes in the Standard Model and beyond.
#
# It is subject to the MadGraph5_aMC@NLO license which should accompany this 
# distribution.
#
# For more information, visit madgraph.phys.ucl.ac.be and amcatnlo.web.cern.ch
#
################################################################################
from __future__ import division
from __future__ import absolute_import
import subprocess
import unittest
import os
import re
import shutil
import sys
import logging
import time
import tempfile
import math
import madgraph


logger = logging.getLogger('test_cmd')

import tests.unit_tests.iolibs.test_file_writers as test_file_writers

import madgraph.interface.master_interface as MGCmd
import madgraph.interface.madevent_interface as MECmd
import madgraph.interface.launch_ext_program as launch_ext
import madgraph.iolibs.files as files

import madgraph.various.misc as misc
import madgraph.various.lhe_parser as lhe_parser
import madgraph.various.banner as banner_mod
import madgraph.various.lhe_parser as lhe_parser
import madgraph.various.banner as banner

_file_path = os.path.split(os.path.dirname(os.path.realpath(__file__)))[0]
_pickle_path =os.path.join(_file_path, 'input_files')

from madgraph import MG4DIR, MG5DIR, MadGraph5Error, InvalidCmd

from tests.acceptance_tests.test_cmd_madevent import check_html_page
pjoin = os.path.join


#===============================================================================
# TestCmd
#===============================================================================
class TestCPPfromfile(unittest.TestCase): # inherit from upstream test_cmd_madevent
    """test that we can launch everything from a single file"""


    def setUp(self):
        
        self.debuging = unittest.debug
        if self.debuging:
            self.path = pjoin(MG5DIR, 'ACC_TEST')
            if os.path.exists(self.path):
                 shutil.rmtree(self.path)
            os.mkdir(self.path) 
        else:
            self.path = tempfile.mkdtemp(prefix='acc_test_mg5')
        self.run_dir = pjoin(self.path, 'MGPROC') 
        
    
    def tearDown(self):

        if not self.debuging:
            shutil.rmtree(self.path)
        self.assertFalse(self.debuging)

    def load_result(self, run_name):
        
        import madgraph.iolibs.save_load_object as save_load_object
        import madgraph.madevent.gen_crossxhtml as gen_crossxhtml
        
        result = save_load_object.load_from_file(pjoin(self.run_dir,'HTML/results.pkl'))
        return result[run_name]
 
    def check_parton_output(self, run_name='run_01', target_event=100, cross=0, error=9e99, delta_event=0, html=True):
        """Check that parton output exists and reach the targert for event"""
                
        # check that the number of event is fine:
        data = self.load_result(run_name)
        if target_event > 0:
            if delta_event == 0:
                self.assertEqual(target_event, int(data[0]['nb_event']))
            else:
                self.assertLessEqual(abs(int(data[0]['nb_event'])-target_event), delta_event)
        self.assertIn('lhe', data[0].parton)
        
        if cross:
            import math
            new_error = math.sqrt(error**2 + float(data[0]['error'])**2)
            self.assertLess(
                abs(cross - float(data[0]['cross']))/new_error,
                3,
                'cross is %s and not %s. NB_SIGMA %s' % (float(data[0]['cross']), cross, float(data[0]['cross'])/new_error)
            )
            self.assertLess(float(data[0]['error']), 3 * error)
        if html:
            check_html_page(self, pjoin(self.run_dir, 'crossx.html'))
        if 'decayed' not in run_name:
            check_html_page(self, pjoin(self.run_dir,'HTML', run_name, 'results.html'))




# WARNING THIS FILE IS AUTOGENERATED -> edit test_simd_madevent.template
    def test_simd_cpp_eemumua_float(self):
        """e check eemumua in single precision"""

        if logging.getLogger('madgraph').level <= 20:
            stdout=None
            stderr=None
        else:
            devnull =open(os.devnull,'w')
            stdout=devnull
            stderr=devnull
            
        try:
            shutil.rmtree('/tmp/MGPROCESS/')
        except Exception as error:
            pass
        
        cmd = """#title check eemumua in single precision
import model sm
                 set automatic_html_opening False --no_save
                 set notification_center False --no_save
                 generate e+ e- > mu+ mu- a
                 output madevent_simd %s -f -nojpeg
                 launch
                 set nevents 100
                 set floating_type f
#check run_01 0.0266 0.0002854 100

                 """ %self.run_dir

        open(pjoin(self.path, 'mg5_cmd'),'w').write(cmd)
        newenv = os.environ.copy()
        newenv["PYTHONPATH"] = pjoin(MG5DIR, '..')
        subprocess.call([sys.executable, pjoin(MG5DIR, 'bin','mg5_aMC'),'-m','CUDACPP_OUTPUT', 
                         pjoin(self.path, 'mg5_cmd')], env=newenv,
                         #cwd=self.path,
                         stdout=stdout, stderr=stderr)

        self.check_parton_output(cross=0.0266, error=0.0002854, run_name='run_01', html=True)
        event = '%s/Events/run_01/unweighted_events.lhe' % self.run_dir
        if not os.path.exists(event):
            misc.gunzip(event)
        
        lhefile = lhe_parser.EventFile(event)
        nb_event = 0
        for event in lhe_parser.EventFile(event):
            event.check()
            nb_event+=1

        self.assertEqual(nb_event, 100)
# WARNING THIS FILE IS AUTOGENERATED -> edit test_simd_madevent.template
    def test_simd_cpp_heft_ggh_double(self):
        """e testing a HEFT process gg>aa in double precision"""

        if logging.getLogger('madgraph').level <= 20:
            stdout=None
            stderr=None
        else:
            devnull =open(os.devnull,'w')
            stdout=devnull
            stderr=devnull
            
        try:
            shutil.rmtree('/tmp/MGPROCESS/')
        except Exception as error:
            pass
        
        cmd = """#title testing a HEFT process gg>aa in double precision
import model heft
                 set automatic_html_opening False --no_save
                 set notification_center False --no_save
                 generate g g > h > a a
                 output madevent_simd %s -f -nojpeg
                 launch
                 set nevents 100
                 set floating_type d
#check run_01 0.01859 0.0002853789088650386 100

                 """ %self.run_dir

        open(pjoin(self.path, 'mg5_cmd'),'w').write(cmd)
        newenv = os.environ.copy()
        newenv["PYTHONPATH"] = pjoin(MG5DIR, '..')
        subprocess.call([sys.executable, pjoin(MG5DIR, 'bin','mg5_aMC'),'-m','CUDACPP_OUTPUT', 
                         pjoin(self.path, 'mg5_cmd')], env=newenv,
                         #cwd=self.path,
                         stdout=stdout, stderr=stderr)

        self.check_parton_output(cross=0.01859, error=0.0002853789088650386, run_name='run_01', html=True)
        event = '%s/Events/run_01/unweighted_events.lhe' % self.run_dir
        if not os.path.exists(event):
            misc.gunzip(event)
        
        lhefile = lhe_parser.EventFile(event)
        nb_event = 0
        for event in lhe_parser.EventFile(event):
            event.check()
            nb_event+=1

        self.assertEqual(nb_event, 100)
# WARNING THIS FILE IS AUTOGENERATED -> edit test_simd_madevent.template
    def test_simd_cpp_pptt_mixed(self):
        """e check ggtt within mixed mode"""

        if logging.getLogger('madgraph').level <= 20:
            stdout=None
            stderr=None
        else:
            devnull =open(os.devnull,'w')
            stdout=devnull
            stderr=devnull
            
        try:
            shutil.rmtree('/tmp/MGPROCESS/')
        except Exception as error:
            pass
        
        cmd = """#title check ggtt within mixed mode
import model sm
                 set automatic_html_opening False --no_save
                 set notification_center False --no_save
                 generate p p > t t~
                 output madevent_simd %s -f -nojpeg
                 launch
                 set nevents 100
                 set floating_type m
#check run_01 505.5 2.749 100

                 """ %self.run_dir

        open(pjoin(self.path, 'mg5_cmd'),'w').write(cmd)
        newenv = os.environ.copy()
        newenv["PYTHONPATH"] = pjoin(MG5DIR, '..')
        subprocess.call([sys.executable, pjoin(MG5DIR, 'bin','mg5_aMC'),'-m','CUDACPP_OUTPUT', 
                         pjoin(self.path, 'mg5_cmd')], env=newenv,
                         #cwd=self.path,
                         stdout=stdout, stderr=stderr)

        self.check_parton_output(cross=505.5, error=2.749, run_name='run_01', html=True)
        event = '%s/Events/run_01/unweighted_events.lhe' % self.run_dir
        if not os.path.exists(event):
            misc.gunzip(event)
        
        lhefile = lhe_parser.EventFile(event)
        nb_event = 0
        for event in lhe_parser.EventFile(event):
            event.check()
            nb_event+=1

        self.assertEqual(nb_event, 100)
# WARNING THIS FILE IS AUTOGENERATED -> edit test_simd_madevent.template
    def test_simd_cpp_vector_size(self):
        """e: check that multiple vector size returns the same value"""

        if logging.getLogger('madgraph').level <= 20:
            stdout=None
            stderr=None
        else:
            devnull =open(os.devnull,'w')
            stdout=devnull
            stderr=devnull
            
        try:
            shutil.rmtree('/tmp/MGPROCESS/')
        except Exception as error:
            pass
        
        cmd = """#title: check that multiple vector size returns the same value
import model sm
set automatic_html_opening False --no_save
set notification_center False --no_save
generate p p > t t~
output madevent_simd %s -f -nojpeg
launch  
set nevents 100
set floating_type m
set vector_size 16
launch
set vector_size 32
launch
set vector_size 64
#check run_01 505.5 2.749 100
#check run_02 505.5 2.749 100 
#check run_03 505.5 2.749 100

                 """ %self.run_dir

        open(pjoin(self.path, 'mg5_cmd'),'w').write(cmd)
        newenv = os.environ.copy()
        newenv["PYTHONPATH"] = pjoin(MG5DIR, '..')
        subprocess.call([sys.executable, pjoin(MG5DIR, 'bin','mg5_aMC'),'-m','CUDACPP_OUTPUT', 
                         pjoin(self.path, 'mg5_cmd')], env=newenv,
                         #cwd=self.path,
                         stdout=stdout, stderr=stderr)

        self.check_parton_output(cross=505.5, error=2.749, run_name='run_01', html=True)
        event = '%s/Events/run_01/unweighted_events.lhe' % self.run_dir
        if not os.path.exists(event):
            misc.gunzip(event)
        
        lhefile = lhe_parser.EventFile(event)
        nb_event = 0
        for event in lhe_parser.EventFile(event):
            event.check()
            nb_event+=1

        self.assertEqual(nb_event, 100)
        self.check_parton_output(cross=505.5, error=2.749, run_name='run_02', html=False)
        event = '%s/Events/run_02/unweighted_events.lhe' % self.run_dir
        if not os.path.exists(event):
            misc.gunzip(event)
        
        lhefile = lhe_parser.EventFile(event)
        nb_event = 0
        for event in lhe_parser.EventFile(event):
            event.check()
            nb_event+=1

        self.assertEqual(nb_event, 100)
        self.check_parton_output(cross=505.5, error=2.749, run_name='run_03', html=False)
        event = '%s/Events/run_03/unweighted_events.lhe' % self.run_dir
        if not os.path.exists(event):
            misc.gunzip(event)
        
        lhefile = lhe_parser.EventFile(event)
        nb_event = 0
        for event in lhe_parser.EventFile(event):
            event.check()
            nb_event+=1

        self.assertEqual(nb_event, 100)